import{l as e,r as a,a as o,w as l,g as t,o as s,d as i,v as n,f as u,i as r,u as c,p,M as d,Z as m,T as f,Q as g}from"./index-CFSraVz9.js";import{a as h,_ as v}from"./uni-col.BqLUY_aA.js";import{r as _}from"./uni-app.es.klBOcF9e.js";import{_ as y}from"./uni-easyinput.BG8xWcF5.js";import{_ as k}from"./uni-file-picker.DnMTpDey.js";import{_ as w}from"./uni-section.2QgTZDWX.js";import{_ as x}from"./返回.CROdAYn4.js";import{_ as j}from"./更多.BXBfdnkH.js";import{_ as V}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.CIje-GWR.js";const q=V({__name:"SendPost",setup(V){const q=e(""),C=e("");console.log("当前 NODE_ENV:","production"),C.value="https://cdn.luckyiur.com/catcat",q.value="https://pawprintdiaries.luckyiur.com";const E=e([]),P=e([]),T=e(""),B=e("");e("");const S=e=>{E.value.push(...e.tempFilePaths),P.value.push(...e.tempFiles),console.log("已选择的文件路径列表:",E.value),console.log("已选择的文件列表:",P.value)},$=e=>{const{index:a}=e;console.log("已删除图片：",e),a>=0&&a<E.value.length?(E.value.splice(a,1),P.value.splice(a,1),console.log("删除后文件路径列表:",E.value),console.log("删除后文件列表:",P.value)):console.error("索引不合法，无法删除文件。")},b=async()=>{if(console.log("标题：",T.value),console.log("内容：",B.value),0===P.value.length)return void c({title:"至少要选择一张图片噢！",icon:"none"});const e=p("token");if(e)try{const a=await d({url:`${q.value}/api/upload/qiniuUploadToken`,method:"GET",header:{Authorization:`Bearer ${e}`}});if(200!==a.statusCode||"2000"!==a.data.code)throw new Error("获取上传凭证失败");const o=a.data.data.qiniuToken,l=P.value.map((e=>new Promise(((a,l)=>{m({url:"https://upload-z2.qiniup.com",filePath:e.path,name:"file",formData:{token:o,key:`catcat/post_pics/${e.name}`},success:e=>{200===e.statusCode?a(e):l(new Error("图片上传失败"))},fail:e=>{l(e)}})})))),t=await Promise.all(l);console.log("所有图片上传成功:",t);const s=P.value.map((e=>e.name));console.log(s);const i=await d({url:`${q.value}/api/post/addpost`,method:"POST",header:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},data:{title:T.value,article:B.value,pictrueList:s}});200===i.statusCode&&"2000"===i.data.code?(console.log("已完成持久化帖子",i),c({title:"发布成功",icon:"success"}),f()):(console.log("无法持久化",i),c({title:"发布失败",icon:"error"}))}catch(a){console.error("发布过程中发生错误:",a),c({title:"发布失败",icon:"error"})}else c({title:"未找到有效的登录令牌",icon:"error"})};function z(){g({url:"/pages/Home"})}return(e,c)=>{const p=_(a("uni-col"),h),d=r,m=t,f=_(a("uni-row"),v),g=_(a("uni-easyinput"),y),V=_(a("uni-file-picker"),k),q=_(a("uni-section"),w);return s(),o(m,{class:"container"},{default:l((()=>[i(m,{class:"layout"},{default:l((()=>[i(m,{class:"t1"},{default:l((()=>[i(f,{class:"t9zdf",width:750},{default:l((()=>[i(p,{class:"tpk0u",span:8},{default:l((()=>[n("img",{src:x,alt:"",onClick:z,class:"img"})])),_:1}),i(p,{class:"tgq89",span:8},{default:l((()=>[i(m,{class:"t9gh9gh9"},{default:l((()=>[i(d,null,{default:l((()=>[u("发布帖子")])),_:1})])),_:1})])),_:1}),i(p,{class:"t56f7",span:8},{default:l((()=>[n("img",{src:j,alt:""})])),_:1})])),_:1})])),_:1}),i(m,null,{default:l((()=>[i(g,{inputBorder:!1,modelValue:T.value,"onUpdate:modelValue":c[0]||(c[0]=e=>T.value=e),type:"textarea",maxlength:"30",placeholder:"添加标题",style:{height:"70rpx"}},null,8,["modelValue"]),i(g,{inputBorder:!1,type:"textarea",autoHeight:"",modelValue:B.value,"onUpdate:modelValue":c[1]||(c[1]=e=>B.value=e),maxlength:"800",placeholder:"添加内容"},null,8,["modelValue"])])),_:1}),i(m,null,{default:l((()=>[i(q,{title:"请选择要上传的图片",type:"line"},{default:l((()=>[i(m,{class:"example-body"},{default:l((()=>[i(V,{limit:"9",title:"最多选择9张图片","auto-upload":!1,fileMediatype:"image",mode:"grid",onDelete:$,onSelect:S,onSuccess:e.success,onFail:e.fail},null,8,["onSuccess","onFail"])])),_:1})])),_:1}),n("uni-button",{onClick:b,style:{"background-color":"aquamarine","margin-top":"30rpx",width:"350rpx"}},"立即发表")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-680f6dba"]]);export{q as default};
